<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="https://www.w3.org/2005/Atom">
	<channel>
		<title>小p的成长历程</title>
		<description>chunpat</description>
		<link>/</link>
		<atom:link href="/" rel="self" type="application/rss+xml" />
		
			<item>
				<title>Linux角色，目录权限(含实际案例)</title>
				<description>&lt;h2 id=&quot;起因&quot;&gt;起因&lt;/h2&gt;

&lt;p&gt;有时候程序写入内容、创建文件目录无权限问题导致程序异常。这大部分是没有搞清权限
和角色的问题。今天就结合实际案例去复习并整理下。&lt;/p&gt;

&lt;h2 id=&quot;知识储备&quot;&gt;知识储备&lt;/h2&gt;

&lt;h3 id=&quot;基础&quot;&gt;基础&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;权限&lt;/th&gt;
      &lt;th&gt;解释&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;读取（r）&lt;/td&gt;
      &lt;td&gt;允许查看文件内容，显示目录列表，对应数字4&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;写入（w）&lt;/td&gt;
      &lt;td&gt;允许修改文件内容，允许在目录中新建、删除、移动文件或者子目录，对应数字2&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;可执行（x）&lt;/td&gt;
      &lt;td&gt;允许运行程序，切换目录，对应数字1&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;无权限（-）&lt;/td&gt;
      &lt;td&gt;没有权限&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;在某个项目下，操作如下：&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com$ ls -la
total 892
...//省略
-rw-r--r--  1 onehour onehour    146 Mar 10  2022 apidoc.json
...//省略
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;表格解析如下：&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;-rw-r–r–&lt;/th&gt;
      &lt;th&gt;1&lt;/th&gt;
      &lt;th&gt;onehour onehour&lt;/th&gt;
      &lt;th&gt;146&lt;/th&gt;
      &lt;th&gt;Mar 10  2022&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;文件类型与权限&lt;/td&gt;
      &lt;td&gt;如果是目录，表示下面文件个数&lt;/td&gt;
      &lt;td&gt;归属，第一个onehour是属主，第二个是属主的分组&lt;/td&gt;
      &lt;td&gt;文件大小，默认普通文件才直接显示大小，单位字节B。&lt;/td&gt;
      &lt;td&gt;修改日期&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
  &lt;p&gt;文件类型与权限&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;可以拆开四个组件 -、rw-、r–、r–, 对应 文件类型、属主权限 、属组权限 、其他人权限。&lt;/p&gt;

&lt;p&gt;其中文件类型有常用的四种，如下表。&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;文件类型符号&lt;/th&gt;
      &lt;th&gt;代表&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;-&lt;/td&gt;
      &lt;td&gt;普通文件&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;d&lt;/td&gt;
      &lt;td&gt;代表目录&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;c&lt;/td&gt;
      &lt;td&gt;代表字符型文件&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;l&lt;/td&gt;
      &lt;td&gt;代表链接文件&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;操作&quot;&gt;操作&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;权限修改 &lt;strong&gt;chmod&lt;/strong&gt; 原本权限是644-》777&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;我是用权限对应的数字去修改， 如下&lt;/p&gt;
&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt; apidoc.json           
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 onehour onehour 146 Mar 10  2022 apidoc.json
onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo chmod&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; 777 apidoc.json
onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt; apidoc.json 
&lt;span class=&quot;nt&quot;&gt;-rwxrwxrwx&lt;/span&gt; 1 onehour onehour 146 Mar 10  2022 apidoc.json
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;操作解释&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;chmod&lt;/th&gt;
      &lt;th&gt;-R&lt;/th&gt;
      &lt;th&gt;777&lt;/th&gt;
      &lt;th&gt;apidoc.json&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;权限修改&lt;/td&gt;
      &lt;td&gt;下面有目录，继承&lt;/td&gt;
      &lt;td&gt;属主权限 、属组权限 、其他人权限 都是满权限&lt;/td&gt;
      &lt;td&gt;文件&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
  &lt;p&gt;归属（所有权）&lt;strong&gt;chown&lt;/strong&gt; 原本归属是onehour onehour -》www www&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt; apidoc.json 
&lt;span class=&quot;nt&quot;&gt;-rwxrwxrwx&lt;/span&gt; 1 onehour onehour 146 Mar 10  2022 apidoc.json
onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; www:www apidoc.json 
onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt; apidoc.json 
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 www www 146 Mar 10  2022 apidoc.json

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;实战&quot;&gt;实战&lt;/h2&gt;

&lt;p&gt;假设用的是宝塔管理服务器，用的nginx代理服务，执行的用户www:www，默认配置如下：&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;user  www www;  //执行用户
worker_processes auto;
error_log  /www/wwwlogs/nginx_error.log  crit;
pid        /www/server/nginx/logs/nginx.pid;
worker_rlimit_nofile 51200;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;cgi用的是php-fpm，执行的用户www:www，php-fpm.conf配置如下：&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[global]
pid = /www/server/php/72/var/run/php-fpm.pid
error_log = /www/server/php/72/var/log/php-fpm.log
log_level = notice

[www] //执行用户
listen = /tmp/php-cgi-72.sock
listen.backlog = -1
listen.allowed_clients = 127.0.0.1
listen.owner = www
listen.group = www
listen.mode = 0666
user = www
group = www
pm = dynamic
pm.status_path = /phpfpm_72_status
pm.max_children = 100
pm.start_servers = 20
pm.min_spare_servers = 20
pm.max_spare_servers = 70
request_terminate_timeout = 100
request_slowlog_timeout = 30
slowlog = var/log/slow.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;如果我们登录linux服务器，用的是onehour这个账户管理与操作，那么执行git clone 下来的项目会是onehour onehour的用户组。&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot$ ls -lh 
drwxr-xr-x 20 onehour onehour 4.0K Oct  5 21:57 dev.xxx.com
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;这样会存在什么问题呢？&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;如果网站访问，用php-fpm写日志操作，假设写的目录是runtime，如下：&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com$ ls -la runtime/
total 28
drwxr-xr-x  5 onehour onehour  4096 Mar 11  2022 .
drwxr-xr-x 20 onehour onehour  4096 Oct  5 21:57 ..
drwxr-xr-x  3 onehour onehour  4096 Mar 10  2022 cache
drwxr-xr-x 10 onehour onehour  4096 Oct  1 00:30 log
drwxr-xr-x  2 onehour onehour 12288 Oct 10 11:53 temp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;其他用户是r-x，是没有写入权限的。&lt;/p&gt;

&lt;p&gt;解决办法，将runtime目录归于权限为www:www&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com$ sudo chown -R www:www runtime
onehour@iZwz9at7o13nmv1vs5ps94Z:/www/wwwroot/dev.xxx.com$ ls -la runtime/              
total 28
drwxr-xr-x  5 www     www      4096 Mar 11  2022 .
drwxr-xr-x 20 onehour onehour  4096 Oct  5 21:57 ..
drwxr-xr-x  3 www     www      4096 Mar 10  2022 cache
drwxr-xr-x 10 www     www      4096 Oct  1 00:30 log
drwxr-xr-x  2 www     www     12288 Oct 10 11:53 temp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;额外，如果执行脚本，用crontab去跑，这里的执行用户就是登录的账号onehour了,那么写日志是没权限的，这个怎么办呢？&lt;/p&gt;

&lt;p&gt;我这边的做法是将执行crontab的用户改为www去执行。
这里改的话，需要登录对应账号执行crontab -e编辑，或者在root账号下crontab -e -u www。&lt;/p&gt;

&lt;p&gt;如果是脚本，像宝塔的计划任务用的是root执行，可以改写成下面这样:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;su -s /bin/bash - www &amp;lt;&amp;lt;EOF
.......//todo执行的命令
EOF
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;2022年10月15日 21:00:00 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;

&lt;p&gt;1、&lt;a href=&quot;https://segmentfault.com/a/1190000039202476&quot;&gt;一文带你彻底搞懂Linux 文件权限管理&lt;/a&gt;&lt;/p&gt;
</description>
				<pubDate>Sat, 15 Oct 2022 00:00:00 +0800</pubDate>
				<link>/linux-permission.html</link>
				<guid isPermaLink="true">/linux-permission.html</guid>
			</item>
		
			<item>
				<title>处理 Mysql Show Query 实际案例</title>
				<description>&lt;h2 id=&quot;tp51-sql日志&quot;&gt;TP5.1 SQL日志&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;../img/20220517mysql-show-log/1.jpeg&quot; alt=&quot;../img/20220517mysql-show-log/1.jpeg&quot; /&gt;&lt;/p&gt;

&lt;p&gt;总耗时6.983733s, 主要划线的两条sql合计5.5s占据。&lt;/p&gt;

&lt;h2 id=&quot;分析&quot;&gt;分析&lt;/h2&gt;

&lt;p&gt;优先处理store_system_depot_exchange表 索引查看&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; SHOW INDEX FROM store_system_depot_exchange;
+-----------------------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table                       | Non_unique | Key_name     | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+-----------------------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| store_system_depot_exchange |          0 | PRIMARY      |            1 | id          | A         |     2794646 |     NULL | NULL   |      | BTREE      |         |               |
| store_system_depot_exchange |          1 | storeId_type |            1 | store_id    | A         |         975 |     NULL | NULL   |      | BTREE      |         |               |
| store_system_depot_exchange |          1 | storeId_type |            2 | type        | A         |        3965 |     NULL | NULL   | YES  | BTREE      |         |               |
+-----------------------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
3 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;数据查看，0.35s，这里复现不出生产环境&lt;strong&gt;秒&lt;/strong&gt;级查询。&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; SELECT *   FROM `store_system_depot_exchange`  WHERE(`store_id`= 52    AND `create_time`&amp;gt;= '2019-09-01 00:00:00'    AND `create_time`&amp;lt;= '2019-10-17 23:59:59'    AND `type` IN('sale_output', 'repair_output', 'repair_correct_input', 'repair_correct_output')    AND `is_virtual`= 0)  AND `store_system_depot_exchange`.`delete_time` IS NULL;
...省略
:28 | 2019-10-17 09:55:28 | NULL        |          0 |
| 1607603 |    407375 |        0 |       3644 |            7609 | NULL         |        715 |   1 |       714 |       3.00 |       40.00 | sale_output           |       52 | 2019101753505152 | 2019-10-17 10:33:20 | 2019-10-17 10:33:20 | NULL        |          0 |
| 1607896 |    407475 |        0 |       2922 |          209508 | NULL         |          5 |   2 |         3 |       5.00 |       60.00 | sale_output           |       52 | 2019101710154509 | 2019-10-17 11:46:26 | 2019-10-17 11:46:26 | NULL        |          0 |
| 1608514 |    407651 |        0 |       3644 |          209547 | NULL         |          5 |   1 |         4 |       2.50 |       10.00 | sale_output           |       52 | 2019101710056511 | 2019-10-17 14:11:29 | 2019-10-17 14:11:29 | NULL        |          0 |
+---------+-----------+----------+------------+-----------------+--------------+------------+-----+-----------+------------+-------------+-----------------------+----------+------------------+---------------------+---------------------+-------------+------------+
999 rows in set (0.35 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;explain 分析&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; explain SELECT *   FROM `store_system_depot_exchange`  WHERE(`store_id`= 52    AND `create_time`&amp;gt;= '2019-09-01 00:00:00'    AND `create_time`&amp;lt;= '2019-10-17 23:59:59'    AND `type` IN('sale_output', 'repair_output', 'repair_correct_input', 'repair_correct_output')    AND `is_virtual`= 0)  AND `store_system_depot_exchange`.`delete_time` IS NULL;
+----+-------------+-----------------------------+------------+-------+---------------+--------------+---------+------+-------+----------+------------------------------------+
| id | select_type | table                       | partitions | type  | possible_keys | key          | key_len | ref  | rows  | filtered | Extra                              |
+----+-------------+-----------------------------+------------+-------+---------------+--------------+---------+------+-------+----------+------------------------------------+
|  1 | SIMPLE      | store_system_depot_exchange | NULL       | range | storeId_type  | storeId_type | 97      | NULL | 60632 |     0.11 | Using index condition; Using where |
+----+-------------+-----------------------------+------------+-------+---------------+--------------+---------+------+-------+----------+------------------------------------+
1 row in set, 1 warning (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;更改索引idx_storeId_createtime ，丢弃idx_storeId_type，type重复率高，放入索引没啥效果，选create_time高变动的数据。&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; CREATE INDEX idx_storeId_createtime ON store_system_depot_exchange (store_id,create_time);
Query OK, 0 rows affected (13.80 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt;  DROP INDEX idx_storeId_type ON store_system_depot_exchange; 
 Query OK, 0 rows affected (0.05 sec)
Records: 0  Duplicates: 0  Warnings: 0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;再次查询&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; SELECT *   FROM `store_system_depot_exchange`  WHERE(`store_id`= 52    AND `create_time`&amp;gt;= '2019-09-01 00:00:00'    AND `create_time`&amp;lt;= '2019-10-17 23:59:59'    AND `type` IN('sale_output', 'repair_output', 'repair_correct_input', 'repair_correct_output')    AND `is_virtual`= 0)  AND `store_system_depot_exchange`.`delete_time` IS NULL;
....省略
----+---------------------+-------------+------------+
999 rows in set (0.02 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;有关-mysql-select-qc缓存&quot;&gt;有关 Mysql Select QC缓存&lt;/h2&gt;

&lt;p&gt;在阿里云的云数据库RDS中，语句第一次查询可以复现，但是第二次就快很多倍。想到的是缓存，就查了相关资料，了解到是Select Query Cache如下。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;查询缓存使用情况&lt;/p&gt;
  &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; SHOW STATUS LIKE 'Qcache%';
+-------------------------+--------+
| Variable_name           | Value  |
+-------------------------+--------+
| Qcache_free_blocks      | 0      |
| Qcache_free_memory      | 0      |
| Qcache_hits             | 0      |
| Qcache_inserts          | 0      |
| Qcache_lowmem_prunes    | 0      |
| Qcache_not_cached       | 668762 |
| Qcache_queries_in_cache | 0      |
| Qcache_total_blocks     | 0      |
+-------------------------+--------+
8 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;  &lt;/div&gt;
&lt;/blockquote&gt;

&lt;p&gt;相关解释：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Qcache_free_blocks: 查询缓存的可用内存量 如果该值非常大，则表明缓冲区中碎片很多。&lt;/li&gt;
  &lt;li&gt;Qcache_free_memory: 查询缓存的可用内存量 Query Cache 中目前剩余的内存大小。通过这个参数我们可以较为准确的观察出当前系统中的Query Cache 内存大小是否足够，是需要增加还是过多了；&lt;/li&gt;
  &lt;li&gt;Qcache_hits: 查询缓存命中数 多少次命中。通过这个参数我们可以查看到Query Cache 的基本效果；&lt;/li&gt;
  &lt;li&gt;Qcache_inserts: 添加到查询缓存的查询数 多少次未命中然后插入。通过“Qcache_hits”和“Qcache_inserts”两个参数我们就可以算出Query Cache 的命中率了：Query Cache 命中率= Qcache_hits / ( Qcache_hits + Qcache_inserts )；&lt;/li&gt;
  &lt;li&gt;Qcache_lowmem_prunes: 由于内存不足而从查询缓存中删除的查询数 值非常大，则表明经常出现缓冲不够的情况;&lt;/li&gt;
  &lt;li&gt;Qcache_not_cached: 非缓存查询的数量（由于 query_cache_type 设置而无法缓存或未缓存） 因为query_cache_type 的设置或者不能被cache 的Query 的数量；&lt;/li&gt;
  &lt;li&gt;Qcache_queries_in_cache: 查询缓存中注册的查询数 当前Query Cache 中cache 的Query 数量；&lt;/li&gt;
  &lt;li&gt;Qcache_total_blocks: 查询缓存中的块总数 表示当前查询缓存占用的内存的block数量&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;查找缓存开启情况&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;查询&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; SHOW  variables LIKE 'query_cache_type';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| query_cache_type | OFF   |
+------------------+-------+
1 row in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;注意：即使是OFF, ALIYUN MYSQL在短时间内查询还是会使用缓存&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;缓存关闭与开启&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;1、临时的直接再命令行执行&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;set global query_cache_size=0
set global query_cache_type=0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2、永久&lt;/p&gt;

&lt;p&gt;my.cnf修改query_cache_size=0、query_cache_type=0&lt;/p&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;2022年05月17日 23:59:59 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;

&lt;p&gt;1、&lt;a href=&quot;https://www.cnblogs.com/WangXianSCU/p/14490217.html&quot;&gt;MySQL查询缓存简单使用 - pedro7 - 博客园&lt;/a&gt;&lt;/p&gt;
</description>
				<pubDate>Tue, 17 May 2022 00:00:00 +0800</pubDate>
				<link>/mysql-slow-log.html</link>
				<guid isPermaLink="true">/mysql-slow-log.html</guid>
			</item>
		
			<item>
				<title>PHP 单元测试 与 Gitlab-CI</title>
				<description>&lt;h2 id=&quot;简介&quot;&gt;简介&lt;/h2&gt;

&lt;p&gt;不做单元测试，你对你的代码有信心吗？&lt;/p&gt;

&lt;h2 id=&quot;安装&quot;&gt;安装&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;1、composer 组件安装&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;2、composer.phar指令&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;官方案例&quot;&gt;官方案例&lt;/h2&gt;

&lt;p&gt;这里结合ThinkPHP6 做案例，PHPUnit 8 的版本。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;安装组件包&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;//直接组件安装
composer require --dev phpunit/phpunit ^8

//查看版本
➜  tp6 git:(master) ✗ ./vendor/bin/phpunit --version
PHPUnit 8.5.26 #StandWithUkraine
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;修改composer.json的自动加载目录&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    ...
    &quot;autoload&quot;: {
        &quot;psr-4&quot;: {
            &quot;app\\&quot;: &quot;app&quot;,
            &quot;tests\\&quot;: &quot;tests&quot;
        },
        &quot;psr-0&quot;: {
            &quot;&quot;: &quot;extend/&quot;
        }
    },
    ...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;案例代码&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;//
&amp;lt;?php

namespace tests\src;

use think\exception\InvalidArgumentException;

final class Email
{
    private $email;

    private function __construct(string $email)
    {
        $this-&amp;gt;ensureIsValidEmail($email);

        $this-&amp;gt;email = $email;
    }

    public static function fromString(string $email): self
    {
        return new self($email);
    }

    public function __toString(): string
    {
        return $this-&amp;gt;email;
    }

    private function ensureIsValidEmail(string $email): void
    {
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            throw new InvalidArgumentException(
                sprintf(
                    '&quot;%s&quot; is not a valid email address',
                    $email
                )
            );
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;测试案例代码&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php

namespace tests;

use PHPUnit\Framework\TestCase;
use tests\src\Email;
use think\exception\InvalidArgumentException;

final class EmailTest extends TestCase
{
    public function testCanBeCreatedFromValidEmailAddress(): void
    {
        $this-&amp;gt;assertInstanceOf(
            Email::class,
            Email::fromString('user@example.com')
        );
    }

    public function testCannotBeCreatedFromInvalidEmailAddress(): void
    {
        $this-&amp;gt;expectException(InvalidArgumentException::class);

        Email::fromString('invalid');
    }

    public function testCanBeUsedAsString(): void
    {
        $this-&amp;gt;assertEquals(
            'user@example.com',
            Email::fromString('user@example.com')
        );
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;使用PHPSTORM的自带命令测试&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;phpstorm测试结果如下&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/usr/local/Cellar/php/7.3.9_1/bin/php /Volumes/work/www/zzhpeng/tp6/vendor/phpunit/phpunit/phpunit --no-configuration --filter tests\\EmailTest --test-suffix EmailTest.php /Volumes/work/www/zzhpeng/tp6/tests --teamcity --cache-result-file=/Volumes/work/www/zzhpeng/tp6/.phpunit.result.cache
Testing started at 12:10 AM ...
PHPUnit 8.5.26 #StandWithUkraine



Time: 104 ms, Memory: 6.00 MB

OK (3 tests, 3 assertions)

Process finished with exit code 0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;2022年04月18日 23:59:59 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;

&lt;p&gt;1、&lt;/p&gt;
</description>
				<pubDate>Mon, 18 Apr 2022 00:00:00 +0800</pubDate>
				<link>/phpunit-test.html</link>
				<guid isPermaLink="true">/phpunit-test.html</guid>
			</item>
		
			<item>
				<title>基于阿里云日志服务（SLS）做日志处理方案</title>
				<description>&lt;h2 id=&quot;关于日志服务sls&quot;&gt;关于日志服务（SLS）&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;介绍&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;这里有几个概念，项目project，日志存储Logstore，集器logtail，机器组。
&lt;img src=&quot;../img/log-system/log-system_1.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;计费&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;为什么用&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;采集&quot;&gt;采集&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;认证&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;如果同一ECS账号下,不用身份认证&lt;/p&gt;

&lt;h2 id=&quot;生产者规范&quot;&gt;生产者规范&lt;/h2&gt;

&lt;h2 id=&quot;应用案例&quot;&gt;应用案例&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;nginx 统计pv pu&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;项目异常处理&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;error 外其他级别处理，汇中统计&lt;/p&gt;

&lt;p&gt;error 等级别，立即报警&lt;/p&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;2022年03月26日 23:59:59 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;

&lt;p&gt;1、&lt;/p&gt;
</description>
				<pubDate>Sat, 26 Mar 2022 00:00:00 +0800</pubDate>
				<link>/log-system.html</link>
				<guid isPermaLink="true">/log-system.html</guid>
			</item>
		
			<item>
				<title>PHP 异常处理</title>
				<description>&lt;h2 id=&quot;php-错误处理&quot;&gt;PHP 错误处理&lt;/h2&gt;

&lt;p&gt;PHP因为便捷灵活，入门门槛低，严谨包容性大，如果使用不当，就容易写出很多难以入目与维护的代码。至此，如果想项目长久发展。
配置好相应的设置，加强把控至关重要。&lt;/p&gt;

&lt;h2 id=&quot;php-的错误级别种类&quot;&gt;PHP 的错误级别种类&lt;/h2&gt;

&lt;p&gt;摘取了宝塔管理软件下的php.ini 配置下关于错误处理与记录的描述。&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Error handling and logging ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; This directive informs PHP of which errors, warnings and notices you would like
; it to take action for. The recommended way of setting values for this
; directive is through the use of the error level constants and bitwise
; operators. The error level constants are below here for convenience as well as
; some common settings and their meanings.
; By default, PHP is set to take action on all errors, notices and warnings EXCEPT
; those related to E_NOTICE and E_STRICT, which together cover best practices and
; recommended coding standards in PHP. For performance reasons, this is the
; recommend error reporting setting. Your production server shouldn't be wasting
; resources complaining about best practices and coding standards. That's what
; development servers and development settings are for.
; Note: The php.ini-development file has this setting as E_ALL. This
; means it pretty much reports everything which is exactly what you want during
; development and early testing.
;
; Error Level Constants:
; E_ALL             - All errors and warnings (includes E_STRICT as of PHP 5.4.0)
; E_ERROR           - fatal run-time errors
; E_RECOVERABLE_ERROR  - almost fatal run-time errors
; E_WARNING         - run-time warnings (non-fatal errors)
; E_PARSE           - compile-time parse errors
; E_NOTICE          - run-time notices (these are warnings which often result
;                     from a bug in your code, but it's possible that it was
;                     intentional (e.g., using an uninitialized variable and
;                     relying on the fact it is automatically initialized to an
;                     empty string)
; E_STRICT          - run-time notices, enable to have PHP suggest changes
;                     to your code which will ensure the best interoperability
;                     and forward compatibility of your code
; E_CORE_ERROR      - fatal errors that occur during PHP's initial startup
; E_CORE_WARNING    - warnings (non-fatal errors) that occur during PHP's
;                     initial startup
; E_COMPILE_ERROR   - fatal compile-time errors
; E_COMPILE_WARNING - compile-time warnings (non-fatal errors)
; E_USER_ERROR      - user-generated error message
; E_USER_WARNING    - user-generated warning message
; E_USER_NOTICE     - user-generated notice message
; E_DEPRECATED      - warn about code that will not work in future versions
;                     of PHP
; E_USER_DEPRECATED - user-generated deprecation warnings
;
; Common Values:
;   E_ALL (Show all errors, warnings and notices including coding standards.)
;   E_ALL &amp;amp; ~E_NOTICE  (Show all errors, except for notices)
;   E_ALL &amp;amp; ~E_NOTICE &amp;amp; ~E_STRICT  (Show all errors, except for notices and coding standards warnings.)
;   E_COMPILE_ERROR|E_RECOVERABLE_ERROR|E_ERROR|E_CORE_ERROR  (Show only errors)
; Default Value: E_ALL &amp;amp; ~E_NOTICE &amp;amp; ~E_STRICT &amp;amp; ~E_DEPRECATED
; Development Value: E_ALL
; Production Value: E_ALL &amp;amp; ~E_DEPRECATED &amp;amp; ~E_STRICT
; http://php.net/error-reporting
error_reporting = E_ALL &amp;amp; ~E_NOTICE

; This directive controls whether or not and where PHP will output errors,
; notices and warnings too. Error output is very useful during development, but
; it could be very dangerous in production environments. Depending on the code
; which is triggering the error, sensitive information could potentially leak
; out of your application such as database usernames and passwords or worse.
; For production environments, we recommend logging errors rather than
; sending them to STDOUT.
; Possible Values:
;   Off = Do not display any errors
;   stderr = Display errors to STDERR (affects only CGI/CLI binaries!)
;   On or stdout = Display errors to STDOUT
; Default Value: On
; Development Value: On
; Production Value: Off
; http://php.net/display-errors
display_errors = On

; The display of errors which occur during PHP's startup sequence are handled
; separately from display_errors. PHP's default behavior is to suppress those
; errors from clients. Turning the display of startup errors on can be useful in
; debugging configuration problems. We strongly recommend you
; set this to 'off' for production servers.
; Default Value: Off
; Development Value: On
; Production Value: Off
; http://php.net/display-startup-errors
display_startup_errors = Off

; Besides displaying errors, PHP can also log errors to locations such as a
; server-specific log, STDERR, or a location specified by the error_log
; directive found below. While errors should not be displayed on productions
; servers they should still be monitored and logging is a great way to do that.
; Default Value: Off
; Development Value: On
; Production Value: On
; http://php.net/log-errors
log_errors = On

; Set maximum length of log_errors. In error_log information about the source is
; added. The default is 1024 and 0 allows to not apply any maximum length at all.
; http://php.net/log-errors-max-len
log_errors_max_len = 1024

; Do not log repeated messages. Repeated errors must occur in same file on same
; line unless ignore_repeated_source is set true.
; http://php.net/ignore-repeated-errors
ignore_repeated_errors = Off

; Ignore source of message when ignoring repeated messages. When this setting
; is On you will not log errors with repeated messages from different files or
; source lines.
; http://php.net/ignore-repeated-source
ignore_repeated_source = Off

; If this parameter is set to Off, then memory leaks will not be shown (on
; stdout or in the log). This has only effect in a debug compile, and if
; error reporting includes E_WARNING in the allowed list
; http://php.net/report-memleaks
report_memleaks = On

; This setting is on by default.
;report_zend_debug = 0

; Store the last error/warning message in $php_errormsg (boolean). Setting this value
; to On can assist in debugging and is appropriate for development servers. It should
; however be disabled on production servers.
; This directive is DEPRECATED.
; Default Value: Off
; Development Value: Off
; Production Value: Off
; http://php.net/track-errors
;track_errors = Off

; Turn off normal error reporting and emit XML-RPC error XML
; http://php.net/xmlrpc-errors
;xmlrpc_errors = 0

; An XML-RPC faultCode
;xmlrpc_error_number = 0

; When PHP displays or logs an error, it has the capability of formatting the
; error message as HTML for easier reading. This directive controls whether
; the error message is formatted as HTML or not.
; Note: This directive is hardcoded to Off for the CLI SAPI
; Default Value: On
; Development Value: On
; Production value: On
; http://php.net/html-errors
html_errors = On

; If html_errors is set to On *and* docref_root is not empty, then PHP
; produces clickable error messages that direct to a page describing the error
; or function causing the error in detail.
; You can download a copy of the PHP manual from http://php.net/docs
; and change docref_root to the base URL of your local copy including the
; leading '/'. You must also specify the file extension being used including
; the dot. PHP's default behavior is to leave these settings empty, in which
; case no links to documentation are generated.
; Note: Never use this feature for production boxes.
; http://php.net/docref-root
; Examples
;docref_root = &quot;/phpmanual/&quot;

; http://php.net/docref-ext
;docref_ext = .html

; String to output before an error message. PHP's default behavior is to leave
; this setting blank.
; http://php.net/error-prepend-string
; Example:
;error_prepend_string = &quot;&amp;lt;span style='color: #ff0000'&amp;gt;&quot;

; String to output after an error message. PHP's default behavior is to leave
; this setting blank.
; http://php.net/error-append-string
; Example:
;error_append_string = &quot;&amp;lt;/span&amp;gt;&quot;

; Log errors to specified file. PHP's default behavior is to leave this value
; empty.
; http://php.net/error-log
; Example:
error_log = /tmp/php_errors.log
; Log errors to syslog (Event Log on Windows).
;error_log = syslog

;windows.show_crt_warning
; Default value: 0
; Development value: 0
; Production value: 0

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;下面是官方中文版的解释，链接：&lt;a href=&quot;https://www.php.net/manual/zh/errorfunc.constants.php&quot;&gt;https://www.php.net/manual/zh/errorfunc.constants.php&lt;/a&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;值&lt;/th&gt;
      &lt;th&gt;常量&lt;/th&gt;
      &lt;th&gt;说明&lt;/th&gt;
      &lt;th&gt;备注&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;E_ERROR (int)&lt;/td&gt;
      &lt;td&gt;致命的运行时错误。这类错误一般是不可恢复的情况，例如内存分配导致的问题。后果是导致脚本终止不再继续运行。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;E_WARNING (int)&lt;/td&gt;
      &lt;td&gt;运行时警告 (非致命错误)。仅给出提示信息，但是脚本不会终止运行。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;E_PARSE (int)&lt;/td&gt;
      &lt;td&gt;编译时语法解析错误。解析错误仅仅由分析器产生。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;8&lt;/td&gt;
      &lt;td&gt;E_NOTICE (int)&lt;/td&gt;
      &lt;td&gt;运行时通知。表示脚本遇到可能会表现为错误的情况，但是在可以正常运行的脚本里面也可能会有类似的通知。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;16&lt;/td&gt;
      &lt;td&gt;E_CORE_ERROR (int)&lt;/td&gt;
      &lt;td&gt;在 PHP 初始化启动过程中发生的致命错误。该错误类似 E_ERROR，但是是由 PHP 引擎核心产生的。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;32&lt;/td&gt;
      &lt;td&gt;E_CORE_WARNING (int)&lt;/td&gt;
      &lt;td&gt;PHP 初始化启动过程中发生的警告 (非致命错误) 。类似 E_WARNING，但是是由 PHP 引擎核心产生的。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;64&lt;/td&gt;
      &lt;td&gt;E_COMPILE_ERROR (int)&lt;/td&gt;
      &lt;td&gt;致命编译时错误。类似 E_ERROR，但是是由 Zend 脚本引擎产生的。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;128&lt;/td&gt;
      &lt;td&gt;E_COMPILE_WARNING (int)&lt;/td&gt;
      &lt;td&gt;编译时警告 (非致命错误)。类似 E_WARNING，但是是由 Zend 脚本引擎产生的。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;256&lt;/td&gt;
      &lt;td&gt;E_USER_ERROR (int)&lt;/td&gt;
      &lt;td&gt;用户产生的错误信息。类似 E_ERROR，但是是由用户自己在代码中使用 PHP 函数 trigger_error()来产生的。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;512&lt;/td&gt;
      &lt;td&gt;E_USER_WARNING (int)&lt;/td&gt;
      &lt;td&gt;用户产生的警告信息。类似 E_WARNING，但是是由用户自己在代码中使用 PHP 函数 trigger_error()来产生的。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;1024&lt;/td&gt;
      &lt;td&gt;E_USER_NOTICE (int)&lt;/td&gt;
      &lt;td&gt;用户产生的通知信息。类似 E_NOTICE，但是是由用户自己在代码中使用 PHP 函数 trigger_error()来产生的。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2048&lt;/td&gt;
      &lt;td&gt;E_STRICT (int)&lt;/td&gt;
      &lt;td&gt;启用 PHP 对代码的修改建议，以确保代码具有最佳的互操作性和向前兼容性。&lt;/td&gt;
      &lt;td&gt;PHP 5.4.0 之前的版本中不包含 E_ALL&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4096&lt;/td&gt;
      &lt;td&gt;E_RECOVERABLE_ERROR&lt;/td&gt;
      &lt;td&gt;(int)    可被捕捉的致命错误。 它表示发生了一个可能非常危险的错误，但是还没有导致PHP引擎处于不稳定的状态。 如果该错误没有被用户自定义句柄捕获 (参见 set_error_handler())，将成为一个 E_ERROR　从而脚本会终止运行。&lt;/td&gt;
      &lt;td&gt;自 PHP 5.2.0 起&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;8192&lt;/td&gt;
      &lt;td&gt;E_DEPRECATED (int)&lt;/td&gt;
      &lt;td&gt;运行时通知。启用后将会对在未来版本中可能无法正常工作的代码给出警告。&lt;/td&gt;
      &lt;td&gt;自 PHP 5.3.0 起&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;16384&lt;/td&gt;
      &lt;td&gt;E_USER_DEPRECATED&lt;/td&gt;
      &lt;td&gt;(int)    用户产生的警告信息。 类似 E_DEPRECATED, 但是是由用户自己在代码中使用PHP函数 trigger_error()来产生的。&lt;/td&gt;
      &lt;td&gt;自 PHP 5.3.0 起&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;32767&lt;/td&gt;
      &lt;td&gt;E_ALL (int)&lt;/td&gt;
      &lt;td&gt;PHP 5.4.0 之前为 E_STRICT 除外的所有错误和警告信息。 PHP 5.4.x 中为 32767, PHP 5.3.x 中为 30719, PHP 5.2.x 中为 6143, 更早之前的 PHP 版本中为 2047。&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;我截取配置，把注释去掉，并在对应下方加上自己的理解，来源：https://www.php.net/manual/zh/errorfunc.configuration.php&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;error_reporting = E_ALL &amp;amp; ~E_NOTICE
//错误显示级别
display_errors = On
//错误显示开关
display_startup_errors = Off
//启动php显示错误，这个在开发环境是开启，生产关闭。
log_errors = On
//错误日志记录开关
log_errors_max_len = 1024
//不记录重复的信息。重复的错误必须出现在同一个文件中的同一行代码上，除非 ignore_repeated_source 设置为true。
ignore_repeated_errors = Off
//忽略重复消息时，也忽略消息的来源。当该设置开启时，重复信息将不会记录它是由不同的文件还是不同的源代码行产生的。
ignore_repeated_source = Off
忽略重复消息时，也忽略消息的来源。当该设置开启时，重复信息将不会记录它是由不同的文件还是不同的源代码行产生的。
report_memleaks = On
如果这个参数设置为Off，则内存泄露信息不会显示 (在 stdout 或者日志中)。
html_errors = On
在错误信息中关闭HTML标签。这种新的HTML格式的错误信息是可以点击，它引导用户前往描述该错误或者导致该错误发生的函数的参考信息页面。 
error_log = /tmp/php_errors.log
设置脚本错误将被记录到的文件。该文件必须是web服务器用户可写的。
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;原生代码演示&quot;&gt;原生代码演示&lt;/h2&gt;

&lt;p&gt;这里演示日常开发常常遇到的，分别是&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;1、E_NOTICE (int)&lt;/li&gt;
  &lt;li&gt;2、E_PARSE (int)&lt;/li&gt;
  &lt;li&gt;3、E_STRICT (int)&lt;/li&gt;
  &lt;li&gt;4、E_DEPRECATED (int)&lt;/li&gt;
  &lt;li&gt;5、E_WARNING (int)&lt;/li&gt;
  &lt;li&gt;6、E_ERROR (int)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;首先默认配置如下，error_reporting = E_ALL &amp;amp; ~E_NOTICE，表示所有错误都显示出来，除了E_NOTICE，这里为了测试
E_NOTICE是什么错误，我配置修改为如下：&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;error_reporting = E_ALL
//错误显示级别
display_errors = On
//错误显示开关
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;针对上面日常遇到的错误，进行代码实操：&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;E_NOTICE&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;实例代码&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
echo $aa;

// Notice: Undefined variable: aa in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;E_WARNING&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;实例代码&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
echo aa;

// Warning: Use of undefined constant aa - assumed 'aa' (this will throw an Error in a future version of PHP) in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 2
string(1) &quot;a&quot;

&amp;lt;?php
$person-&amp;gt;name = 'Rasmus Lerdorf';
//Warning: Creating default object from empty value in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;E_PARSE (int)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;实例代码&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;z = 1;
// Parse error: syntax error, unexpected '=' in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;E_DEPRECATED (int)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;实例代码&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
$size = mcrypt_get_block_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_ECB);

// Deprecated: Function mcrypt_get_block_size() is deprecated in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;E_STRICT (int)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;抱歉，PHP7.0以后就没有这个分类了，合并到其他分类去了&lt;/strong&gt; ，来源链接: &lt;a href=&quot;https://wiki.php.net/rfc/reclassify_e_strict&quot;&gt;https://wiki.php.net/rfc/reclassify_e_strict&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;下面演示的是旧版本，PHP7.0前版本。&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
class Person {
    var $name;

    function __construct($name) {
        $this-&amp;gt;name = $name;
    }

    function Person($name) {
        $this-&amp;gt;name = $name;
    }
}

//PHP Strict Standards:  var: Deprecated. Please use the public/private/protected modifiers
                  PHP Strict Standards:  Redefining already defined constructor for class Person
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;E_ERROR (int)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;实例代码&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
$aa = null;
var_dump( $aa-&amp;gt;toArray());  //这操作在ORM 对象操作经常遇到
// Fatal error: Uncaught Error: Call to a member function toArray() on null in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php:3 Stack trace: #0 {main} thrown in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 3

class Person {
    var $name;

    function __construct($name) {
        $this-&amp;gt;name = $name;
    }

    function Person($name) {
        $this-&amp;gt;name = $name;
    }
}

Person::Person();

// Fatal error: Uncaught Error: Non-static method Person::Person() cannot be called statically in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php:14 Stack trace: #0 {main} thrown in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 14

function test($test){
}
test();

//Fatal error: Uncaught ArgumentCountError: Too few arguments to function test(), 0 passed in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 6 and exactly 1 expected in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php:2 Stack trace: #0 /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php(6): test() #1 {main} thrown in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 2

throw new \Exception('aaa');
//Fatal error: Uncaught Exception: aaa in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php:2 Stack trace: #0 {main} thrown in /Volumes/work/www/onehour/onehour_docker/www/sima2/test.php on line 2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;处理异常&quot;&gt;处理异常&lt;/h2&gt;

&lt;p&gt;日常开发中可以直接抛出错误，但是在生产环境中，有些警告类非中断的错误是不能影响正常业务流程的。如除了E_ERROR会中断。
那怎么办呢？可以使用set_error_handler处理并且记录异常，而不影响正常业务。 set_error_handler 不会捕抓 E_ERROR,
E_PARSE, E_CORE_ERROR, E_CORE_WARNING, E_COMPILE_ERROR, E_COMPILE_WARNING。下面是原文：&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;//https://www.php.net/manual/en/function.set-error-handler
The following error types cannot be handled with a user defined function: E_ERROR, E_PARSE,
E_CORE_ERROR, E_CORE_WARNING, E_COMPILE_ERROR, E_COMPILE_WARNING independent of where they
were raised, and most of E_STRICT raised in the file where set_error_handler() is called.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;thinkphp异常处理&quot;&gt;ThinkPHP异常处理&lt;/h2&gt;

&lt;p&gt;这里演示的是ThinkPhp5.1版本的异常处理
入口文件./public/index.php，加载了基础/../thinkphp/base.php&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;// ./public/index.php
&amp;lt;?php
// [ 应用入口文件 ]
namespace think;

// 加载基础文件  15行
require __DIR__ . '/../thinkphp/base.php';
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;在/../thinkphp/base.php，加载各类基础服务&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;// ./public/index.php
&amp;lt;?php
// 注册错误和异常处理机制 19行
Error::register();
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;在/../thinkphp/library/think/Error.php，注册异常服务，写异常handle处理方法&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    // /../thinkphp/library/think/Error.php 32行
    /**
     * 注册异常处理
     * @access public
     * @return void
     */
    public static function register()
    {
        error_reporting(E_ALL);
        set_error_handler([__CLASS__, 'appError']);
        set_exception_handler([__CLASS__, 'appException']);
        register_shutdown_function([__CLASS__, 'appShutdown']);
    }
    
    /**
     * Error Handler
     * @access public
     * @param  integer $errno   错误编号
     * @param  integer $errstr  详细错误信息
     * @param  string  $errfile 出错的文件
     * @param  integer $errline 出错行号
     * @throws ErrorException
     */
    public static function appError($errno, $errstr, $errfile = '', $errline = 0)
    {
        $exception = new ErrorException($errno, $errstr, $errfile, $errline); //这里重写异常
        if (error_reporting() &amp;amp; $errno) {
            // 将错误信息托管至 think\exception\ErrorException
            throw $exception;  //这里抛出异常
        }

        self::getExceptionHandler()-&amp;gt;report($exception); // 这里写日志
    }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;在/../thinkphp/library/think/exception/Error.php， 封装重写\Exception。&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
namespace think\exception;

use think\Exception;

/**
 * ThinkPHP错误异常
 * 主要用于封装 set_error_handler 和 register_shutdown_function 得到的错误
 * 除开从 think\Exception 继承的功能
 * 其他和PHP系统\ErrorException功能基本一样
 */
class ErrorException extends Exception
{
    /**
     * 用于保存错误级别
     * @var integer
     */
    protected $severity;

    /**
     * 错误异常构造函数
     * @access public
     * @param  integer $severity 错误级别
     * @param  string  $message  错误详细信息
     * @param  string  $file     出错文件路径
     * @param  integer $line     出错行号
     */
    public function __construct($severity, $message, $file, $line)
    {
        $this-&amp;gt;severity = $severity;
        $this-&amp;gt;message  = $message;  //这里重写内核\Exception的变量message、file、line、code
        $this-&amp;gt;file     = $file;
        $this-&amp;gt;line     = $line;
        $this-&amp;gt;code     = 0;
    }

    /**
     * 获取错误级别
     * @access public
     * @return integer 错误级别
     */
    final public function getSeverity()
    {
        return $this-&amp;gt;severity;
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;总结：&lt;strong&gt;ThinkPHP把所有错误级别都抛出，这里需要改造成警告类的错误在生产环境写入日志而不抛出&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;举例： 在application/common.php 写入。&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;function myErrorHandler($errno, $errstr, $errfile, $errline)
{
    if (!(error_reporting() &amp;amp; $errno)) {
        // This error code is not included in error_reporting, so let it fall
        // through to the standard PHP error handler
        return false;
    }

    // $errstr may need to be escaped:
    $errstr = htmlspecialchars($errstr);

    switch ($errno) {
        case E_DEPRECATED:
            //记录日志
            trace(&quot;&amp;lt;b&amp;gt;DEPRECATED&amp;lt;/b&amp;gt; [$errno] $errstr&quot;);
            return true;
        case E_NOTICE:
            //记录日志
            trace(&quot;&amp;lt;b&amp;gt;NOTICE&amp;lt;/b&amp;gt; : [$errno] $errstr&quot;);
            return true;
        case E_WARNING:
            //记录日志
            trace(&quot;&amp;lt;b&amp;gt;WARNING&amp;lt;/b&amp;gt; : [$errno] $errstr&quot;);
            return true;
        default:
           //记录日志
            trace(&quot;Unknown error type: [$errno] $errstr&quot;);
            return true;
    }
    /* Don't execute PHP internal error handler */
    return true;
}
// set to the user defined error handler
set_error_handler(&quot;myErrorHandler&quot;);
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;laravel异常处理&quot;&gt;Laravel异常处理&lt;/h2&gt;

&lt;p&gt;查看laravel 版本&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;➜  laravel git:(master) ✗ php artisan --version
Laravel Framework 8.83.3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;composer.json文件&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;//composer.json 35行
&quot;scripts&quot;: {
    &quot;post-autoload-dump&quot;: [
        &quot;Illuminate\\Foundation\\ComposerScripts::postAutoloadDump&quot;,  
        &quot;@php artisan package:discover --ansi&quot;
    ],
    &quot;post-update-cmd&quot;: [
        &quot;@php artisan vendor:publish --tag=laravel-assets --ansi --force&quot;
    ],
    &quot;post-root-package-install&quot;: [
        &quot;@php -r \&quot;file_exists('.env') || copy('.env.example', '.env');\&quot;&quot;
    ],
    &quot;post-create-project-cmd&quot;: [
        &quot;@php artisan key:generate --ansi&quot;
    ]
},
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Illuminate\Foundation\ComposerScripts::postAutoloadDump 这个静态方法，composer update 产生
/../vendor/autoload.php，加载所有核心。&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;//Illuminate\\Foundation\\ComposerScripts::postAutoloadDump 41行
public static function postAutoloadDump(Event $event)
{
    require_once $event-&amp;gt;getComposer()-&amp;gt;getConfig()-&amp;gt;get('vendor-dir').'/autoload.php';

    static::clearCompiled();
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后错误处理在这里Illuminate\Foundation\Bootstrap&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;// Illuminate\Foundation\Bootstrap 37行
public function bootstrap(Application $app)
{
    self::$reservedMemory = str_repeat('x', 10240);

    $this-&amp;gt;app = $app;

    error_reporting(-1);

    set_error_handler([$this, 'handleError']);

    set_exception_handler([$this, 'handleException']);

    register_shutdown_function([$this, 'handleShutdown']);

    //这里关闭了
    if (! $app-&amp;gt;environment('testing')) {
        ini_set('display_errors', 'Off');
    }
}

public function handleError($level, $message, $file = '', $line = 0, $context = [])
{
    if ($this-&amp;gt;isDeprecation($level)) {
        return $this-&amp;gt;handleDeprecation($message, $file, $line);
    }

    if (error_reporting() &amp;amp; $level) {
        //这里是错误封装
        throw new ErrorException($message, 0, $level, $file, $line);
    }
}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;2022年03月18日 23:59:59 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;

&lt;p&gt;1、&lt;/p&gt;
</description>
				<pubDate>Fri, 18 Mar 2022 00:00:00 +0800</pubDate>
				<link>/php-exception.html</link>
				<guid isPermaLink="true">/php-exception.html</guid>
			</item>
		
			<item>
				<title>Self-host Gitlab的相关操作</title>
				<description>&lt;h1 id=&quot;安装debian-系列系统为例&quot;&gt;安装（Debian 系列系统为例）&lt;/h1&gt;

&lt;h2 id=&quot;apt-get-直接安装&quot;&gt;apt-get 直接安装&lt;/h2&gt;

&lt;p&gt;更新gitlab源&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;安装，默认最新版&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt-get install gitlab-ce
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;进阶debian-系列系统为例&quot;&gt;进阶（Debian 系列系统为例）&lt;/h1&gt;

&lt;h2 id=&quot;已有nginx想用原来的服务&quot;&gt;已有Nginx，想用原来的服务&lt;/h2&gt;

&lt;p&gt;停gitlab自带的nginx，并且修改外部web server权限用户。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-$xslt&quot;&gt;sudo vim /etc/gitlab/gitlab.rb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;修改地方，如下图：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../img/2022-01-08-gitlab/advanced_1.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;修改完，重新加载配置&amp;amp;重启即可。&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#重新加载配置
sudo gitlab-ctl reconfigure

#重启
sudo gitlab-ctl restart

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;定期备份与清理&quot;&gt;定期备份与清理&lt;/h2&gt;

&lt;h3 id=&quot;备份&quot;&gt;备份&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;1、创建备份脚本，每天00自动备份&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;sudo vim /var/opt/gitlab/backups/backup.sh&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#!/bin/bash
/opt/gitlab/bin/gitlab-rake gitlab:backup:create
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;crontab -e&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#!/bin/bash
0 0 * * * sh /var/opt/gitlab/backups/backup.sh &amp;gt;&amp;gt; /var/opt/gitlab/backups/backup.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;2、更改用户组(当前操作的是onehour用户)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo chown -R git:git /var/opt/gitlab/backups/backup.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;3、测试&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo sh /var/opt/gitlab/backups/backup.sh &amp;gt;&amp;gt; /var/opt/gitlab/backups/backup.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;4、设置contab&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;切换到root用户执行contab&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;contab -e
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;用nano操作&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;0 0 * * * sh /var/opt/gitlab/backups/backup.sh &amp;gt;&amp;gt; /var/opt/gitlab/backups/backup.log

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ctrl+X，按Y保存&lt;/p&gt;

&lt;h3 id=&quot;清理&quot;&gt;清理&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;1、创建备份脚本，15天前的数据自动删除&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;sudo vim /var/opt/gitlab/backups/remove.sh&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#!/bin/bash
find &quot;/var/opt/gitlab/backups/&quot; -name &quot;*.tar&quot; -ctime +15  -exec rm -rf {} \;  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;2、更改用户组(当前操作的是onehour用户)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo chown -R git:git /var/opt/gitlab/backups/remove.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;3、测试&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo sh /var/opt/gitlab/backups/remove.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;4、设置contab&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;切换到root用户执行contab&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;contab -e
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;用nano操作&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;45 10 * * * sh /var/opt/gitlab/backups/remove.sh  &amp;gt;&amp;gt; /var/opt/gitlab/backups/remove.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ctrl+X，按Y保存&lt;/p&gt;

&lt;h2 id=&quot;升级gitlab&quot;&gt;升级gitlab&lt;/h2&gt;

&lt;p&gt;升级前记得备份好数据，以防Error，官方介绍 &lt;a href=&quot;https://about.gitlab.com/install/#ubuntu&quot;&gt;https://about.gitlab.com/install/#ubuntu&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意，从低版本一次性升级到高版本可能会出问题，所以官方出了个逐步升级的路线图&lt;/strong&gt;
8.11.Z -&amp;gt; 8.12.0 -&amp;gt; 8.17.7 -&amp;gt; 9.5.10 -&amp;gt; 10.8.7 -&amp;gt; 11.11.8 -&amp;gt; 12.0.12 -&amp;gt; 
12.1.17 -&amp;gt; 12.10.14 -&amp;gt; 13.0.14 -&amp;gt; 13.1.11 -&amp;gt; 13.8.8 -&amp;gt; latest 13.12.Z -&amp;gt; latest 14.0.Z -&amp;gt; latest 14.1.Z -&amp;gt; latest 14.Y.Z&lt;/p&gt;

&lt;p&gt;官方升级路径：&lt;a href=&quot;https://docs.gitlab.com/ee/update/index.html#upgrade-paths&quot;&gt;https://docs.gitlab.com/ee/update/index.html#upgrade-paths&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;查看版本&quot;&gt;查看版本&lt;/h3&gt;

&lt;p&gt;查看详细的版本信息&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; sudo gitlab-rake gitlab:env:info
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;到官方包库寻找对应版本&quot;&gt;到官方包库寻找对应版本&lt;/h3&gt;

&lt;p&gt;包地址
&lt;a href=&quot;https://packages.gitlab.com/gitlab/gitlab-ce/&quot;&gt;https://packages.gitlab.com/gitlab/gitlab-ce/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;操作前，先更新gitlab资源路径&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查找对应的包，点击进去能看到详情，可以看到apt怎么操作之类的，例如安装12.1.17版本&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt-get install gitlab-ce=12.1.17-ce.0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;这里的安装即是安装也是更新，会把你的数据也一起迁移了&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;然后重启gitlab&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo gitlab-ctl restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;重启nginx，我这里用的是外部的nginx，而且用的TCP连接，所以需要重启，重新连接socket。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注意，升级到13.5.1-ce.0后，要修改nginx 转发代理的路劲&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#原来
upstream gitlab-workhorse {
  server unix:/var/opt/gitlab/gitlab-workhorse/socket  fail_timeout=0;
}

#修改
upstream gitlab-workhorse {
  server unix:/var/opt/gitlab/gitlab-workhorse/sockets/socket  fail_timeout=0;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2022年01月08日 03:11:40 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;
&lt;p&gt;1、&lt;a href=&quot;https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/5756&quot;&gt;Permission denied on sockets after update to “13.5.1-ce.0” (#5756) · Issues · GitLab.org / omnibus-gitlab · GitLab&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2、&lt;a href=&quot;https://www.cnblogs.com/cheyunhua/p/14875506.html&quot;&gt;gitlab备份、还原及迁移 - 技术颜良 - 博客园&lt;/a&gt;&lt;/p&gt;
</description>
				<pubDate>Sat, 08 Jan 2022 00:00:00 +0800</pubDate>
				<link>/gitlab.html</link>
				<guid isPermaLink="true">/gitlab.html</guid>
			</item>
		
			<item>
				<title>区块链游戏 crypto-zoon，从入门到入坑</title>
				<description>&lt;h2 id=&quot;1出国&quot;&gt;1、出国&lt;/h2&gt;

&lt;p&gt;国内有些线路访问对区块链相关的不太友好，所有要先出国。这里介绍两个工具，佛跳墙和panda。
佛跳墙有免费线路，不建议充值，我年初的时候充的一年费用，但是最近他家东西线路没怎么维护。
佛跳墙不行，所以今天刚充Panda 1年送1年，2年59刀，很划算，线路多，延迟低，主要是同事推荐用了很长时间，在google shop 应用
排前头。&lt;/p&gt;

&lt;p&gt;佛跳墙：https://github.com/getfotiaoqiang/download&lt;/p&gt;

&lt;p&gt;Panda: https://www.pantavv.xyz/i/46214283&lt;/p&gt;

&lt;h2 id=&quot;2下载谷歌浏览器&quot;&gt;2、下载谷歌浏览器&lt;/h2&gt;

&lt;p&gt;官网下载（需要fanq）：https://www.google.cn/chrome/&lt;/p&gt;

&lt;p&gt;国内搜索资源站，不过绑定的流氓软件多&lt;/p&gt;

&lt;h2 id=&quot;3安装谷歌浏览器metamask钱包插件&quot;&gt;3、安装谷歌浏览器Metamask钱包插件&lt;/h2&gt;

&lt;p&gt;谷歌浏览器访问 https://chrome.google.com/webstore/category/extensions?hl=zh-CN 到应用商店。&lt;/p&gt;

&lt;p&gt;搜索Metamask，看到狐狸，点击第一个进入，然后点击按钮 ‘添加到Chrome’。&lt;/p&gt;

&lt;p&gt;安装成功后，如下图；
&lt;img src=&quot;http://img.zzhpeng.cn/FlL0LgTjt2miSjMcqfVaFaSJAVOx&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;然后就是新建钱包或者导入其他钱包的&lt;strong&gt;私钥（私钥是命，要保管好）。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;创建BSC（Binance Smart Chain）链钱包，具体操作看下面这个链接：
https://academy.binance.com/zh/articles/connecting-metamask-to-binance-smart-chain&lt;/p&gt;

&lt;p&gt;创建好后，基于bsc链加 zoon 合约地址 0x9d173e6c594f479b4d47001f8e6a95a7adda42bc&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FhttIQe6deo38nATVqv-5H-JgxhM&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;4购买zoon代币买宠物&quot;&gt;4、购买zoon代币，买宠物&lt;/h2&gt;

&lt;p&gt;查看代币的行情与购买：https://www.dextools.io/app/pancakeswap/pair-explorer/0xdf7646371fd995dfe3f9665e6382b40cd008e889&lt;/p&gt;

&lt;p&gt;购买的话，可以用上面的网址，链接小狐狸，bnb购买（Binance网址：http://accounts.binancezh.cz/zh-CN/register?ref=91791353）, 如下图
&lt;img src=&quot;http://img.zzhpeng.cn/FlcwLZQ4h8cQWmj2Ad3ZdeZ-O8Ig&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;进官网：https://app.cryptozoon.io/&lt;/p&gt;

&lt;p&gt;用钱包连接登录，登录后，如下图：
&lt;img src=&quot;http://img.zzhpeng.cn/Fla79qXsoq5-9J6QD_SMZTsPrs2D&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;购买宠物可以去市场买。&lt;/p&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2021年08月27日 01:11:40 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;相关资料&quot;&gt;相关资料：&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;1、游戏排名：http://dappradar.com/&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;2、PC 🦊加BSC 链： https://academy.binance.com/zh/articles/connecting-metamask-to-binance-smart-chain&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;3、视频介绍：https://www.bilibili.com/video/BV1R44y1C78H?from=search&amp;amp;seid=9001485312838677239&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;4、文章介绍：https://mp.weixin.qq.com/s/aoq0J15BTYJ84SB4RrjIRQ&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;5、zoon行情：https://www.dextools.io/app/pancakeswap/pair-explorer/0xdf7646371fd995dfe3f9665e6382b40cd008e889&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;6、官方文档：https://docs-cn.cryptozoon.io/zoan-you-xi/yu-zhong-he-sheng-chang&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;7、官方网址：https://app.cryptozoon.io/&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;8、zoon代币地址：0x9d173e6c594f479b4d47001f8e6a95a7adda42bc&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Fri, 27 Aug 2021 00:00:00 +0800</pubDate>
				<link>/crypto-zoon.html</link>
				<guid isPermaLink="true">/crypto-zoon.html</guid>
			</item>
		
			<item>
				<title>MySQL的Replace操作</title>
				<description>&lt;h2 id=&quot;缘由&quot;&gt;缘由&lt;/h2&gt;

&lt;p&gt;想复现两条重复的数据，但是一直被替换，死死不出来。查看sql日志，发现出现了Replace操作，之前没见过，词义为替换。
第一时间想的是和索引有关，看了下还真是，去掉索引之后就复现了数据。&lt;/p&gt;

&lt;h2 id=&quot;日志&quot;&gt;日志&lt;/h2&gt;

&lt;p&gt;tp5.1日志，出现了REPLACE&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[ sql ] [ SQL ] REPLACE INTO `store_system_depot_goods_detail` 
(`goods_name` , `classify_type_id` , `skus_json` , `store_id` , 
`account_id` , `goods_sn` , `classify_id` , `goods_id` , `create_time` ,
 `update_time`) VALUES ('定义商品编码' , 1 , '{\&quot;\\u5c0f\\u7c73\\u673a\\u578b\&quot;:\&quot;HM-\\u7ea2\\u7c73NOTE5\&quot;}' , 
 0 , 2269 , '6931755509057' , 1 , 426741 , '2021-04-19 10:23:45' , 
 '2021-04-19 10:23:45') [ RunTime:0.008989s ]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;怎么实现&quot;&gt;怎么实现&lt;/h2&gt;
&lt;p&gt;tp5.1，php代码,路径thinkphp/library/think/model/relation/HasMany.php，一对多关联的时候使用&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    /**
     * 保存（新增）当前关联数据对象
     * @access public
     * @param  mixed    $data       数据 可以使用数组 关联模型对象 和 关联对象的主键
     * @param  boolean  $replace    是否自动识别更新和写入
     * @return Model|false
     */
    public function save($data, $replace = true)
    {
        if ($data instanceof Model) {
            $data = $data-&amp;gt;getData();
        }

        // 保存关联表数据
        $data[$this-&amp;gt;foreignKey] = $this-&amp;gt;parent-&amp;gt;{$this-&amp;gt;localKey};

        $model = new $this-&amp;gt;model;

        return $model-&amp;gt;replace($replace)-&amp;gt;save($data) ? $model : false;
    }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;tp5.1 最终Sql转换code，thinkphp/library/think/db/Builder.php&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;     /**
      * 生成Insert SQL
      * @access public
      * @param  Query     $query   查询对象
      * @param  bool      $replace 是否replace
      * @return string
      */
     public function insert(Query $query, $replace = false)
     {
         $options = $query-&amp;gt;getOptions();
 
         // 分析并处理数据
         $data = $this-&amp;gt;parseData($query, $options['data']);
         if (empty($data)) {
             return '';
         }
 
         $fields = array_keys($data);
         $values = array_values($data);
 
         return str_replace(
             ['%INSERT%', '%TABLE%', '%FIELD%', '%DATA%', '%COMMENT%'],
             [
                 $replace ? 'REPLACE' : 'INSERT',
                 $this-&amp;gt;parseTable($query, $options['table']),
                 implode(' , ', $fields),
                 implode(' , ', $values),
                 $this-&amp;gt;parseComment($query, $options['comment']),
             ],
             $this-&amp;gt;insertSql);
     }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;结论：Replace是由Mysql自己做处理的&lt;/p&gt;

&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;慎用MySQL Replace语句&lt;/strong&gt;，存在PRIMARY KEY或者UNIQUE索引，有利有弊。利：可以做去重处理。
弊：删除旧数据新增新数据。&lt;/p&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2021年04月19日 11:26:40 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考：&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;1、&lt;a href=&quot;https://www.cnblogs.com/sunss/p/4493803.html&quot;&gt;慎用MySQL replace语句 - sunss - 博客园&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Mon, 19 Apr 2021 00:00:00 +0800</pubDate>
				<link>/mysql-replace.html</link>
				<guid isPermaLink="true">/mysql-replace.html</guid>
			</item>
		
			<item>
				<title>关于TCP</title>
				<description>&lt;h2 id=&quot;tcp-简介&quot;&gt;TCP 简介&lt;/h2&gt;

&lt;p&gt;传输控制协议（TCP，Transmission Control Protocol）,是一种面向连接的，可靠的，基于字节流的传输层通讯协议。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FpwQJ6gLG0ZnS8oh83PpPVDyEPxN&quot; alt=&quot;FpwQJ6gLG0ZnS8oh83PpPVDyEPxN&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;tcp-三次握手常见的问题&quot;&gt;TCP 三次握手常见的问题&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;1、连接拒绝 Operation now in progress （前提tcp_abort_on_overflow=0）&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;丢包: 路由器丢包&lt;/li&gt;
  &lt;li&gt;错误ip：ip错误、port服务端应用没用&lt;/li&gt;
  &lt;li&gt;backlog满了：  第三次握手的时候把建立好的连接放到全连接backlog队列里面，backlog长度有限,此参数将决定最多同时有多少个等待 &lt;strong&gt;accept&lt;/strong&gt; 的连接。&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;2、连接被重置 Connection reset by peer （前提tcp_abort_on_overflow=1）&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;backlog满了：客户端发送SYN，服务端返回Rst让客户端重连&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;3、SYN FLOOD&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;客户端第三次ACK不发送，半连接backlog满了&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;查看backlog满，服务端阻塞&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -s |grep ‘times the listen queue of a socket overflowed’
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;tcp-四次挥手常见的问题&quot;&gt;TCP 四次挥手常见的问题&lt;/h2&gt;

&lt;p&gt;主要是客户端的TIME WAIT和服务端的CLOSE WAIT引起&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;四元组&lt;/strong&gt;，(客户端ip + 客户端port + 服务端ip + 服务端port) 确认一个链接&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;1、持续一分钟，包的存活时间&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;挥手第四个步骤，服务端没有收到客户端的ACK，过一段时间会重传FIN，客户端的TIME WAIT阶段会存留一分钟。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;2、Cannot assign requested address&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;客户端端口用光了，主要是客户端一分钟TIME WAIT占用端口&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;php-fpm经常会遇到，因为是用完即释放&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;3、Address already in use&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;重启服务，客户端TIME WAIT占用端口。解决：设置so REUSEADDR （swoole 默认开启）&lt;/p&gt;

&lt;p&gt;其他解决办法&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;net.ipv4.tcp_timestamps=1
net.ipv4.tcp_tw_reuse=1
net.ipv4.ip_local_port_range调大
不要开启net.ipv4.tcp_tw_recycle=1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;4、大量 CLOSE WAIT 链接占用服务端资源&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;服务端应用close方法出现异常，没有调用close方法。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;扩展&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;swoole server SWOOLE_PROCESS模式close方法决定是否释放close
swoole server SWOOLE_BASE模式 会自动调用底层FIN close释放，不会存在大量close wait&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$serv = new Swoole\Server(&quot;0.0.0.0&quot;, 9501, SWOOLE_BASE); //SWOOLE_PROCESS
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;tcp-短连接问题&quot;&gt;TCP 短连接问题&lt;/h2&gt;

&lt;p&gt;短连接顾名思义：用完即释放&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;1、多余传输&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;需要握手，挥手&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;2、TCP慢启动&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;TCP建立连接需要网络评估&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;3、握手阶段丢包&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;网络抖动，如发生在握手阶段重传耗秒级别，而在连接阶段重传在毫秒级别。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;4、对连接的占用约等于长连接&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;占用资源和长连接差不多&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;优点&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1、简单&lt;/li&gt;
  &lt;li&gt;2、理论上连接数相对少&lt;/li&gt;
  &lt;li&gt;3、无状态对LB负载均衡友好，效果好（长连接不释放连接一直占用，分发负载不了）&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;tcp-长连接的常见问题&quot;&gt;TCP 长连接的常见问题&lt;/h2&gt;

&lt;p&gt;举例图：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FunbR-4EnUkQ12hoYtV2KXFfgxbF&quot; alt=&quot;FunbR-4EnUkQ12hoYtV2KXFfgxbF&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;1链接失效&quot;&gt;1、链接失效&lt;/h3&gt;

&lt;p&gt;长连接应用层表现：&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Redis ：timeout(Error while reading line from the server)&lt;/li&gt;
  &lt;li&gt;Mysql: wait timeout &amp;amp; interactive_timeout(has gone away)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;解决办法：&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;1、用的时候重试，但是存在以下问题&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;1、server 断开后占用连接资源（内存、端口、句柄），被动断开close_wait永远不会消失&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;举例：以上图为例，服务端超时没收到东西，发送FIN到php客户端，php 底层tcp回ACK确认收到。但是长连接处于被动状态不发FIN到服务端主动关闭链接。
这样服务端就处于在FIN_WAIT2、客户端在CLOSE_WAIT状态。
客户端就一直处于CLOSE_WAIT，相反服务端由于有系统设置服务端自动断开连接（os系统超时时间）&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;net.ipv4.tcp_fin_timesout = 30
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;所以服务端不会保持在FIN_WAIT2状态。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;2、面临短连接的问题&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;3、优点简单&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;2、定时发心跳维持连接 tcp_keepalive&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;需要解决的问题&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;1、心跳检测时间不够灵活&lt;/li&gt;
  &lt;li&gt;2、设置定时时间段检测 (早上八点检测)&lt;/li&gt;
  &lt;li&gt;3、无法检测假死，两个连接，依赖第三方redis服务&lt;/li&gt;
  &lt;li&gt;4、依赖网络环境，需要稳定&lt;/li&gt;
  &lt;li&gt;5、不是直连，通过代理链接，如socks5只转发应用层的包，不转发探测包&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;1、tcp_keepalive&lt;/p&gt;

&lt;p&gt;2、swoole tcp_keepalive&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$serv = new Swoole\Server(&quot;192.168.2.194&quot;, 6666, SWOOLE_PROCESS);
$serv-&amp;gt;set(array(
    'worker_num' =&amp;gt; 1,
    'open_tcp_keepalive' =&amp;gt; true,
    'tcp_keepidle' =&amp;gt; 4, //4s没有数据传输就进行检测
    'tcp_keepinterval' =&amp;gt; 1, //1s探测一次
    'tcp_keepcount' =&amp;gt; 5, //探测的次数，超过5次后还没回包close此连接
));

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3、swoole heartbeat_idle_time(连接最大允许空闲的时间)&lt;/p&gt;

&lt;p&gt;上面两个keepalive的缺点就是无法检测死链接，死链接会自动回ping检测。&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;array(
    'heartbeat_idle_time'      =&amp;gt; 600, // 表示一个连接如果600秒内未向服务器发送任何数据，此连接将被强制关闭
    'heartbeat_check_interval' =&amp;gt; 60,  // 表示每60秒遍历一次
);
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;结合应用层设置定时心跳发送&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;1、指定ping/pong协议（mysql等自带ping协议）&lt;/li&gt;
  &lt;li&gt;2、客户端灵活的发送ping心跳包&lt;/li&gt;
  &lt;li&gt;3、服务端OnRecive检测可用性回复Pong&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;和检测转发的长连接服务，这相应的可以处理问题3、4、5，对于1、2无法解决。&lt;/p&gt;

&lt;h2 id=&quot;面试常问&quot;&gt;面试常问&lt;/h2&gt;

&lt;p&gt;1、挥手一定是四次吗？&lt;/p&gt;

&lt;p&gt;2、握手为什么是三次？&lt;/p&gt;

&lt;p&gt;3、长连接有哪些问题？&lt;/p&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2020年11月29日 22:28:12 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考：&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;1、&lt;a href=&quot;https://my.oschina.net/costaxu/blog/127394&quot;&gt;几种TCP连接中出现RST的情况 - costaxu的个人页面 - OSCHINA - 中文开源技术交流社区&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;2、&lt;a href=&quot;https://www.cnblogs.com/Orgliny/p/5780796.html&quot;&gt;TCP/IP协议中backlog参数 - Orgliny - 博客园&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;3、&lt;a href=&quot;https://course.swoole-cloud.com/videos/1&quot;&gt;Swoole微课程&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Sun, 29 Nov 2020 00:00:00 +0800</pubDate>
				<link>/tcp.html</link>
				<guid isPermaLink="true">/tcp.html</guid>
			</item>
		
			<item>
				<title>Mysql 逻辑数据恢复</title>
				<description>&lt;h2 id=&quot;起因&quot;&gt;起因&lt;/h2&gt;
&lt;p&gt;有时候线上出了问题，而原本地数据不好操作，所以想把生产的数据弄一份到本地环境测试。操作步骤：1、阿里云RDS导出逻辑。2、导入本地mysql。&lt;/p&gt;

&lt;h2 id=&quot;阿里云rds生成逻辑&quot;&gt;阿里云RDS生成逻辑&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/Fh3k1F_AOs_QW_1tbIFDs3-f9R7M&quot; alt=&quot;Fh3k1F_AOs_QW_1tbIFDs3-f9R7M&quot; /&gt;&lt;/p&gt;

&lt;p&gt;点击确认后，就会生成，然后下载即可。&lt;/p&gt;

&lt;h2 id=&quot;数据库逻辑恢复&quot;&gt;数据库逻辑恢复&lt;/h2&gt;

&lt;p&gt;解压下载后压缩文件，然后选择对应要恢复的数据库。&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;注意：➜ source 是目录&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;➜ source gunzip -c sima_datafull_202009291740_1601372414.sql.gz|mysql -uroot -p sima
Enter password: 
ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;上面出现error&lt;/code&gt;，度娘下，提示集群迁移到单实例的设置问题，操作：&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;➜  source mysql -uroot -p 
Enter password: 
mysql&amp;gt; reset master;
Query OK, 0 rows affected (0.01 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;然后重复上面操作即可。&lt;/p&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2020年10月10日 14:14:40 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考：&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;1、&lt;a href=&quot;https://book.douban.com/subject/23008813/&quot;&gt;高性能mysql&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;2、&lt;a href=&quot;https://www.cnblogs.com/tonnytangy/p/7779164.html&quot;&gt;ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty - tonnytangy - 博客园&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Sat, 10 Oct 2020 00:00:00 +0800</pubDate>
				<link>/mysql-recovery.html</link>
				<guid isPermaLink="true">/mysql-recovery.html</guid>
			</item>
		
	</channel>
</rss>
